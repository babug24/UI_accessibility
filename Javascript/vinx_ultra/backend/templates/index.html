<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>VINX ULTRA — Demo</title>
  <!-- Load a Gemini-like font (Poppins) for the VINX logo/title -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/styles.css" />
</head>
<body>
  <div class="app">
    <header class="topbar">
      <div class="brand">
        <!-- Inline SVG logo -->
        <img src="/static/logo.svg" alt="VINX ULTRA logo" class="logo" />
        <div class="title">VINX ULTRA</div>
      </div>
      <div class="subtitle">Live demo · Blue & White · Streamed replies</div>
    </header>

    <main class="main">
      <section class="left">
        <div id="chat" class="chat"></div>

        <form id="chatForm" class="chat-form">
          <input id="messageInput" name="message" placeholder="Ask VINX ULTRA anything..." />
          <button type="submit">Send</button>
        </form>
      </section>

      <aside class="right">
        <h3>Actions</h3>
        <button id="imgBtn">Generate Image (placeholder)</button>
        <button id="tableBtn">Ask for Table Example</button>
        <hr />
        <div id="status">Status: <span id="statusText">ready</span></div>
      </aside>
    </main>

    <footer class="footer">VINX ULTRA demo — streaming and image placeholders</footer>
  </div>

  <script>
    const chatEl = document.getElementById('chat');
    const form = document.getElementById('chatForm');
    const input = document.getElementById('messageInput');
    const statusText = document.getElementById('statusText');

    function appendMessage(role, html) {
      const wrap = document.createElement('div');
      wrap.className = 'message ' + role;
      wrap.innerHTML = html;
      chatEl.appendChild(wrap);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const text = input.value.trim();
      if (!text) return;
      appendMessage('user', '<div class="bubble">' + escapeHtml(text) + '</div>');
      input.value = '';
      statusText.textContent = 'streaming...';

      // Open a WebSocket to stream responses
      const ws = new WebSocket((location.protocol === 'https:' ? 'wss://' : 'ws://') + location.host + '/ws/chat');

      // Show live response container
      const respWrap = document.createElement('div');
      respWrap.className = 'message vinx';
      const bubble = document.createElement('div');
      bubble.className = 'bubble';
      respWrap.appendChild(bubble);
      chatEl.appendChild(respWrap);

      ws.onopen = () => {
        ws.send(JSON.stringify({prompt: text}));
      };

      ws.onmessage = (ev) => {
        try {
          const obj = JSON.parse(ev.data);
          if (obj.type === 'delta') {
            bubble.innerHTML += escapeHtml(obj.text);
            chatEl.scrollTop = chatEl.scrollHeight;
          } else if (obj.type === 'done') {
            statusText.textContent = 'ready';
            ws.close();
          } else if (obj.type === 'image') {
            bubble.innerHTML += `<div class="image"><img src="${obj.payload.url}" alt="generated"/></div>`;
          } else if (obj.type === 'error') {
            bubble.innerHTML += `<div class="bubble error">Error: ${escapeHtml(obj.reason || obj.message || 'unknown')}</div>`;
            statusText.textContent = 'ready';
            ws.close();
          }
        } catch (err) {
          console.error('invalid ws chunk', ev.data);
        }
      };

      ws.onerror = (err) => {
        console.error('ws error', err);
        statusText.textContent = 'error';
      };

      ws.onclose = () => {
        statusText.textContent = 'ready';
      };

    });

    document.getElementById('imgBtn').addEventListener('click', async () => {
      const prompt = promptFor('Describe the image to generate');
      if (!prompt) return;
      // simple non-streaming call
      const fd = new FormData();
      fd.append('prompt', prompt);
      const r = await fetch('/api/generate_image', {method: 'POST', body: fd});
      const j = await r.json();
      appendMessage('vinx', `<div class="bubble"><img src="${j.url}" alt="gen"/><div class="caption">${escapeHtml(j.caption)}</div></div>`);
    });

    document.getElementById('tableBtn').addEventListener('click', async () => {
      const fd = new FormData();
      fd.append('message', 'table: please compare features');
      const r = await fetch('/api/chat', {method: 'POST', body: fd});
      const j = await r.json();
      if (j.type === 'table') {
        appendMessage('vinx', renderTable(j.table));
      } else {
        appendMessage('vinx', '<div class="bubble">' + escapeHtml(JSON.stringify(j)) + '</div>');
      }
    });

    function renderTable(tbl) {
      let html = '<div class="bubble"><table class="result-table"><thead><tr>';
      for (const h of tbl.headers) html += `<th>${escapeHtml(h)}</th>`;
      html += '</tr></thead><tbody>';
      for (const r of tbl.rows) {
        html += '<tr>';
        for (const c of r) html += `<td>${escapeHtml(c)}</td>`;
        html += '</tr>';
      }
      html += '</tbody></table></div>';
      return html;
    }

    // Simple helpers
    function escapeHtml(s) { return (s+'').replace(/[&<>"]/g, (c) => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c])); }
    function promptFor(msg) { return prompt(msg); }



  </script>
</body>
</html>